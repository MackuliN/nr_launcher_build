name: Build & Release NR EXE

on:
  push:
    paths:
      - .github/workflows/build.yml
  workflow_dispatch:

jobs:
  build:
    if: "!contains(github.event.head_commit.message, '[skip build]')"
    runs-on: windows-latest

    permissions:
      contents: write

    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v3

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.10

    - name: ğŸ“¥ Install requirements
      run: pip install psutil pyinstaller

    - name: ğŸ— Build EXE from launcher_gui.py
      run: pyinstaller --onefile --windowed --hidden-import=psutil launcher_gui.py

    - name: ğŸ“‹ Copy EXE to root
      run: copy dist\\launcher_gui.exe .\\launcher_gui.exe

    - name: ğŸ“¦ Zip EXE
      run: powershell Compress-Archive -Path .\\launcher_gui.exe -DestinationPath launcher.zip

    - name: ğŸ§¾ Generate clean changelog
      id: changelog
      shell: bash
      run: |
        git fetch --tags
        LAST_TAG=$(git tag --sort=-creatordate | head -n1)
        echo "Last tag: $LAST_TAG"

        COMMITS=$(git log "$LAST_TAG"..HEAD --pretty=format:'- %s (%h)')
        COMMITS_ESCAPED="${COMMITS//'%'/'%25'}"
        COMMITS_ESCAPED="${COMMITS_ESCAPED//$'\n'/'%0A'}"
        COMMITS_ESCAPED="${COMMITS_ESCAPED//$'\r'/'%0D'}"
        echo "::set-output name=log::$COMMITS_ESCAPED"

    - name: ğŸš€ Upload to GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: NR Launcher Build ${{ github.run_number }}
        body: ${{ steps.changelog.outputs.log }}
        files: |
          launcher.zip
          launcher_gui.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
